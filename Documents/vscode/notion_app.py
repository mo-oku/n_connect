import base64
import requests
import urllib.parse
import json

"""
このなかでデコードしてNotionに追加
"""


# Notion APIの設定
NOTION_TOKEN = "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"  # NotionのAPIキーをここに入力
DATABASE_ID = "18aaf2e6ffba80289323d2f3402dfa47"  # NotionのデータベースID
NOTION_URL = "https://api.notion.com/v1/pages"

def decode_character_data(encoded_data):
    print("ココフォリアの駒データをデコード")

    # Base64デコード
    decoded_bytes = base64.b64decode(encoded_data)
    decoded_str = decoded_bytes.decode("utf-8")  # バイト列を文字列に変換
    
    # URLデコード（もし必要なら）
    decoded_str = urllib.parse.unquote(decoded_str)

    # JSONとして読み込む
    json_data = json.loads(decoded_str)
    return json_data
    

def add_to_notion(character):
    print("Notionにデータを送信")
    headers = {
        "Authorization": f"Bearer {NOTION_TOKEN}",
        "Content-Type": "application/json",
        "Notion-Version": "2022-06-28"
    }

    data = {
        "parent": {"database_id": DATABASE_ID},
        "properties": {
            "名前": {"title": [{"text": {"content": character["data"]["name"]}}]},
            "HP": {"number": character["data"]["status"][0]["value"]},
            "MP": {"number": character["data"]["status"][1]["value"]},
            "SAN": {"number": character["data"]["status"][2]["value"]},
            "アイコンURL": {"url": character["data"]["iconUrl"]}
        }
    }

    response = requests.post(NOTION_URL, headers=headers, json=data)
    print("Notion登録完了:", response.status_code, response.text)

# --- テストデータ（Base64でエンコードされた駒データ） ---
koma_data = '{"kind":"encoded","data":"JTdCJTIya2luZCUyMiUzQSUyMmNoYXJhY3RlciUyMiUyQyUyMmRhdGElMjIlM0ElN0IlMjJuYW1lJTIyJTNBJTIyTWFiZWwlRTMlODMlQkJDYW5jZXIlMjAoJUUzJTgzJUExJUUzJTgyJUE0JUUzJTgzJTk5JUUzJTgzJUFCJUUzJTgzJUJCJUUzJTgyJUFEJUUzJTgzJUEzJUUzJTgzJUIzJUUzJTgyJUI1JUUzJTgzJUJDKSUyMiUyQyUyMm1lbW8lMjIlM0ElMjIlMjIlMkMlMjJpbml0aWF0aXZlJTIyJTNBOCUyQyUyMmV4dGVybmFsVXJsJTIyJTNBJTIyaHR0cHMlM0ElMkYlMkZpYWNoYXJhLmNvbSUyRnZpZXclMkY5NDA0NDAzJTIyJTJDJTIyc3RhdHVzJTIyJTNBJTVCJTdCJTIybGFiZWwlMjIlM0ElMjJIUCUyMiUyQyUyMnZhbHVlJTIyJTNBMTAlMkMlMjJtYXglMjIlM0ExMCU3RCUyQyU3QiUyMmxhYmVsJTIyJTNBJTIyTVAlMjIlMkMlMjJ2YWx1ZSUyMiUzQTE1JTJDJTIybWF4JTIyJTNBMTUlN0QlMkMlN0IlMjJsYWJlbCUyMiUzQSUyMlNBTiUyMiUyQyUyMnZhbHVlJTIyJTNBNzklMkMlMjJtYXglMjIlM0E3OSU3RCU1RCUyQyUyMnBhcmFtcyUyMiUzQSU1QiU3QiUyMmxhYmVsJTIyJTNBJTIyU1RSJTIyJTJDJTIydmFsdWUlMjIlM0ElMjI5JTIyJTdEJTJDJTdCJTIybGFiZWwlMjIlM0ElMjJDT04lMjIlMkMlMjJ2YWx1ZSUyMiUzQSUyMjEyJTIyJTdEJTJDJTdCJTIybGFiZWwlMjIlM0ElMjJQT1clMjIlMkMlMjJ2YWx1ZSUyMiUzQSUyMjE1JTIyJTdEJTJDJTdCJTIybGFiZWwlMjIlM0ElMjJERVglMjIlMkMlMjJ2YWx1ZSUyMiUzQSUyMjglMjIlN0QlMkMlN0IlMjJsYWJlbCUyMiUzQSUyMkFQUCUyMiUyQyUyMnZhbHVlJTIyJTNBJTIyMTQlMjIlN0QlMkMlN0IlMjJsYWJlbCUyMiUzQSUyMlNJWiUyMiUyQyUyMnZhbHVlJTIyJTNBJTIyOCUyMiU3RCUyQyU3QiUyMmxhYmVsJTIyJTNBJTIySU5UJTIyJTJDJTIydmFsdWUlMjIlM0ElMjIxNSUyMiU3RCUyQyU3QiUyMmxhYmVsJTIyJTNBJTIyRURVJTIyJTJDJTIydmFsdWUlMjIlM0ElMjIxMiUyMiU3RCU1RCUyQyUyMmljb25VcmwlMjIlM0ElMjJodHRwcyUzQSUyRiUyRnN0b3JhZ2UuY2Nmb2xpYS1jZG4ubmV0JTJGdXNlcnMlMkZWZThzVXJ4STlTYW1TVnZ4YVpjdERvRjdBV3cyJTJGZmlsZXMlMkYwZTA3NjU4YWVlNGNhMTVlMTJmNDY5YjE5ZmY4ZDEwNWNkMGRkNzg2ZTU3MjZmM2U4OTJkMWE3NjlmNWQxMTk3JTIyJTJDJTIyZmFjZXMlMjIlM0ElNUIlN0IlMjJsYWJlbCUyMiUzQSUyMiUyMiUyQyUyMmljb25VcmwlMjIlM0ElMjJodHRwcyUzQSUyRiUyRnN0b3JhZ2UuY2Nmb2xpYS1jZG4ubmV0JTJGdXNlcnMlMkZWZThzVXJ4STlTYW1TVnZ4YVpjdERvRjdBV3cyJTJGZmlsZXMlMkYwZTA3NjU4YWVlNGNhMTVlMTJmNDY5YjE5ZmY4ZDEwNWNkMGRkNzg2ZTU3MjZmM2U4OTJkMWE3NjlmNWQxMTk3JTIyJTdEJTVEJTJDJTIyYW5nbGUlMjIlM0EwJTJDJTIyd2lkdGglMjIlM0ExMCUyQyUyMmhlaWdodCUyMiUzQTEwJTJDJTIyc2VjcmV0JTIyJTNBZmFsc2UlMkMlMjJpbnZpc2libGUlMjIlM0FmYWxzZSUyQyUyMmhpZGVTdGF0dXMlMjIlM0FmYWxzZSUyQyUyMmNvbG9yJTIyJTNBJTIyJTIzODg4ODg4JTIyJTJDJTIyY29tbWFuZHMlMjIlM0ElMjIxZDEwMCUzQyUzRCU3QlNBTiU3RCUyMCVFMyU4MCU5MCVFNiVBRCVBMyVFNiVCMCU5NyVFNSVCQSVBNiVFMyU4MyVBRCVFMyU4MyVCQyVFMyU4MyVBQiVFMyU4MCU5MSU1Q25DQ0IlM0MlM0Q3NSUyMCVFMyU4MCU5MCVFMyU4MiVBMiVFMyU4MiVBNCVFMyU4MyU4NyVFMyU4MiVBMiVFMyU4MCU5MSU1Q25DQ0IlM0MlM0Q3NSUyMCVFMyU4MCU5MCVFNSVCOSVCOCVFOSU4MSU4QiVFMyU4MCU5MSU1Q25DQ0IlM0MlM0Q2MCUyMCVFMyU4MCU5MCVFNyU5RiVBNSVFOCVBRCU5OCVFMyU4MCU5MSU1Q25DQ0IlM0MlM0Q3NSUyMCVFMyU4MCU5MCVFNyU5QiVBRSVFNiU5OCU5RiVFMyU4MCU5MSU1Q25DQ0IlM0MlM0Q2NSUyMCVFMyU4MCU5MCVFOCU4MSU5RSVFMyU4MSU4RCVFOCU4MCVCMyVFMyU4MCU5MSU1Q25DQ0IlM0MlM0QyNSUyMCVFMyU4MCU5MCVFNSU5QiVCMyVFNiU5QiVCOCVFOSVBNCVBOCVFMyU4MCU5MSU1Q25DQ0IlM0MlM0Q2NiUyMCVFMyU4MCU5MCVFNSU5QiU5RSVFOSU4MSVCRiVFMyU4MCU5MSU1Q25DQ0IlM0MlM0Q1MCUyMCVFMyU4MCU5MCVFMyU4MSU5MyVFMyU4MSVCNiVFMyU4MSU5NyVFRiVCQyU4OCVFMyU4MyU5MSVFMyU4MyVCMyVFMyU4MyU4MSVFRiVCQyU4OSVFMyU4MCU5MSU1Q25DQ0IlM0MlM0Q4MCUyMCVFMyU4MCU5MCVFNSVCRiU5QyVFNiU4MCVBNSVFNiU4OSU4QiVFNSVCRCU5MyVFMyU4MCU5MSU1Q25DQ0IlM0MlM0QzMCUyMCVFMyU4MCU5MCVFOSU5QSVBMCVFMyU4MiU4QyVFMyU4MiU4QiVFMyU4MCU5MSU1Q25DQ0IlM0MlM0Q2MSUyMCVFMyU4MCU5MCVFNyVCMiVCRSVFNyVBNSU5RSVFNSU4OCU4NiVFNiU5RSU5MCVFMyU4MCU5MSU1Q25DQ0IlM0MlM0Q0NSUyMCVFMyU4MCU5MCVFOCVBQSVBQyVFNSVCRSU5NyVFMyU4MCU5MSU1Q25DQ0IlM0MlM0QyJTIwJUUzJTgwJTkwJUUzJTgyJUFGJUUzJTgzJTg4JUUzJTgyJUE1JUUzJTgzJUFCJUUzJTgzJTk1JUU3JUE1JTlFJUU4JUE5JUIxJUUzJTgwJTkxJTVDbkNDQiUzQyUzRDQ1JTIwJUUzJTgwJTkwJUU4JThBJUI4JUU4JUExJTkzJUVGJUJDJTg4JUUzJTgxJUFEJUUzJTgxJThCJUUzJTgxJTk3JUUzJTgxJUE0JUUzJTgxJTkxJUVGJUJDJTg5JUUzJTgwJTkxJTVDbkNDQiUzQyUzRDc1JTIwJUUzJTgwJTkwJUU1JUJGJTgzJUU3JTkwJTg2JUU1JUFEJUE2JUUzJTgwJTkxJTVDbkNDQiUzQyUzRDIxJTIwJUUzJTgwJTkwJUU2JUFEJUI0JUU1JThGJUIyJUUzJTgwJTkxJTVDbjFkMyUyQjAlMjAlRTMlODAlOTAlRTMlODMlODAlRTMlODMlQTElRTMlODMlQkMlRTMlODIlQjglRTUlODglQTQlRTUlQUUlOUElRTMlODAlOTElNUNuMWQ0JTJCMCUyMCVFMyU4MCU5MCVFMyU4MyU4MCVFMyU4MyVBMSVFMyU4MyVCQyVFMyU4MiVCOCVFNSU4OCVBNCVFNSVBRSU5QSVFMyU4MCU5MSU1Q24xZDYlMkIwJTIwJUUzJTgwJTkwJUUzJTgzJTgwJUUzJTgzJUExJUUzJTgzJUJDJUUzJTgyJUI4JUU1JTg4JUE0JUU1JUFFJTlBJUUzJTgwJTkxJTVDbkNDQiUzQyUzRCU3QlNUUiU3RCo1JTIwJUUzJTgwJTkwU1RSJTIwJUMzJTk3JTIwNSVFMyU4MCU5MSU1Q25DQ0IlM0MlM0QlN0JDT04lN0QqNSUyMCVFMyU4MCU5MENPTiUyMCVDMyU5NyUyMDUlRTMlODAlOTElNUNuQ0NCJTNDJTNEJTdCUE9XJTdEKjUlMjAlRTMlODAlOTBQT1clMjAlQzMlOTclMjA1JUUzJTgwJTkxJTVDbkNDQiUzQyUzRCU3QkRFWCU3RCo1JTIwJUUzJTgwJTkwREVYJTIwJUMzJTk3JTIwNSVFMyU4MCU5MSU1Q25DQ0IlM0MlM0QlN0JBUFAlN0QqNSUyMCVFMyU4MCU5MEFQUCUyMCVDMyU5NyUyMDUlRTMlODAlOTElNUNuQ0NCJTNDJTNEJTdCU0laJTdEKjUlMjAlRTMlODAlOTBTSVolMjAlQzMlOTclMjA1JUUzJTgwJTkxJTVDbkNDQiUzQyUzRCU3QklOVCU3RCo1JTIwJUUzJTgwJTkwSU5UJTIwJUMzJTk3JTIwNSVFMyU4MCU5MSU1Q25DQ0IlM0MlM0QlN0JFRFUlN0QqNSUyMCVFMyU4MCU5MEVEVSUyMCVDMyU5NyUyMDUlRTMlODAlOTElNUNuJTIyJTdEJTdE"}'
encoded_data = koma_data.removeprefix('{"kind":"encoded","data":"').removesuffix('"}')

# デコード＆Notionに送信
character_data = decode_character_data(encoded_data)
add_to_notion(character_data)
